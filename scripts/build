#!/bin/bash
# NanoDistill Build Script
# Runs all quality checks: format, lint, type-check, and tests
# Exit with error if any check fails

set -e  # Exit on first error

PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$PROJECT_ROOT"

echo "üî® NanoDistill Build Script"
echo "================================"
echo ""

# Colors for output
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

FAILED=0

# 1. Run Ruff (linting and formatting check)
echo "üìã Running Ruff lint checks..."
if uv run ruff check src/ tests/; then
    echo -e "${GREEN}‚úì Ruff checks passed${NC}"
else
    echo -e "${RED}‚úó Ruff checks failed${NC}"
    FAILED=1
fi
echo ""

# 2. Run mypy (type checking)
echo "üîç Running mypy type checks..."
if uv run mypy src/; then
    echo -e "${GREEN}‚úì mypy checks passed${NC}"
else
    echo -e "${RED}‚úó mypy checks failed${NC}"
    FAILED=1
fi
echo ""

# 3. Run pytest (tests)
echo "üß™ Running pytest..."
if uv run pytest tests/ -v --tb=short; then
    echo -e "${GREEN}‚úì Tests passed${NC}"
else
    echo -e "${RED}‚úó Tests failed${NC}"
    FAILED=1
fi
echo ""

# 4. Import validation (compile check)
echo "‚úÖ Validating imports..."
if uv run python -c "from nanodistill import distill; print('‚úì Package imports successfully')"; then
    echo -e "${GREEN}‚úì Import validation passed${NC}"
else
    echo -e "${RED}‚úó Import validation failed${NC}"
    FAILED=1
fi
echo ""

# Summary
echo "================================"
if [ $FAILED -eq 0 ]; then
    echo -e "${GREEN}‚úì All checks passed!${NC}"
    echo ""
    echo "Ready to push üöÄ"
    exit 0
else
    echo -e "${RED}‚úó Some checks failed. Please fix the issues above.${NC}"
    exit 1
fi
